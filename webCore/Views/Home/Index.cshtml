@{
    Layout = "_Layout";
    var categories = ViewBag.Categories as List<webCore.Models.Category>;
    var parentCategories = categories?.Where(c => c.ParentId == null).ToList();
    var groupedProducts = ViewBag.GroupedProducts as Dictionary<string, List<webCore.Models.Product_admin>>;
    var featuredProducts = ViewBag.FeaturedProducts as List<webCore.Models.Product_admin>;

    // Sắp xếp các nhóm sản phẩm theo thứ tự: Gợi ý, Mới, Nổi bật, Không nổi bật
    var orderedGroupedProducts = groupedProducts
        .OrderBy(group =>
            group.Key == "Gợi ý" ? 1 :
            group.Key == "Mới" ? 2 :
            group.Key == "Nổi bật" ? 3 : 4)
        .ToList();
}
@model IEnumerable<Product_admin>
<div class="container">
    <div class="row">
        <aside class="list col-md-4">
            <ul class="list-group">
                <li class="inner-title list-group-item">
                    <h3>Danh mục sản phẩm</h3>
                </li>
                @if (parentCategories != null)
                {
                    foreach (var parent in parentCategories)
                    {
                        <li class="list-group-item" onclick="toggleArrow(this)">
                            <a>@parent.Title<span class="arrow"></span></a>
                            <ul class="list-group subcategories" style="display: none;">
                                @foreach (var sub in categories.Where(c => c.ParentId == parent._id))
                                {
                                    <li class="list-group-item">
                                        <a>@sub.Title</a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }
                }
            </ul>
        </aside>
        <main class="main col-md-8 p-3">
            <div class="main-banner position-relative">
                <!-- Slideshow -->
                <div id="bookCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <img src="/image/image_theme1.jpg" class="d-block w-100" alt="..." />
                            <div class="carousel-caption d-none d-md-block">
                                <button class="btn1">Mua ngay</button>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <img src="/image/image_theme2.jpg" class="d-block w-100" alt="..." />
                            <div class="carousel-caption d-none d-md-block">
                                <button class="btn2">Mua ngay</button>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <img src="/image/image_theme3.jpg" class="d-block w-100" alt="..." />
                            <div class="carousel-caption d-none d-md-block">
                                <button class="btn3">Mua ngay</button>
                            </div>
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#bookCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#bookCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    </button>
                </div>
            </div>

<div class="container">
    <div class="row">
        <!-- Sidebar - Danh mục sản phẩm -->
        <aside class="list col-md-4">
            <ul class="list-group">
                <li class="inner-title list-group-item">
                    <h3>Danh mục sản phẩm</h3>
                </li>
                @if (parentCategories != null)
                {
                    foreach (var parent in parentCategories)
                    {
                        <li class="list-group-item" onclick="toggleArrow(this)">
                            <a>@parent.Title<span class="arrow"></span></a>
                            <ul class="list-group subcategories" style="display: none;">
                                @foreach (var sub in categories.Where(c => c.ParentId == parent._id))
                                {
                                    <li class="list-group-item" onclick="loadProductsByPosition(@sub.Position)">
                                        <a>@sub.Title</a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }
                }
            </ul>
        </aside>

        <!-- Main Content - Sản phẩm -->
        <main class="main col-md-8 p-3">
            <!-- Slideshow -->
            <div id="bookCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="/image/image_theme1.jpg" class="d-block w-100" alt="..." />
                        <div class="carousel-caption d-none d-md-block">
                            <button class="btn1">Mua ngay</button>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="/image/image_theme2.jpg" class="d-block w-100" alt="..." />
                        <div class="carousel-caption d-none d-md-block">
                            <button class="btn2">Mua ngay</button>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="/image/image_theme3.jpg" class="d-block w-100" alt="..." />
                        <div class="carousel-caption d-none d-md-block">
                            <button class="btn3">Mua ngay</button>
                        </div>
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#bookCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#bookCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                </button>
            </div>

            <!-- Danh sách sản phẩm -->
            <div class="product-list mt-5">
                @if (orderedGroupedProducts != null && orderedGroupedProducts.Any())
                {
                    foreach (var group in orderedGroupedProducts)
                    {
                        <h3 class="product-group-name">@group.Key</h3> <!-- Hiển thị tên nhóm sản phẩm -->
                        <div class="row">
                            @foreach (var product in group.Value)
                            {
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <img src="@product.Image" class="card-img-top" alt="@product.Title" />
                                        <div class="card-body">
                                            <h5 class="card-title">@product.Title</h5>
                                            <p class="card-text">
                                                @if (product.DiscountPercentage > 0)
                                                {
                                                    <span class="badge discount-badge">
                                                        Giảm @product.DiscountPercentage%
                                                    </span>
                                                    <br />
                                                    <span class="text-muted old-price">
                                                        @string.Format("{0:C}", product.Price)
                                                    </span>
                                                    <br />
                                                    <span class="price new-price">
                                                        @string.Format("{0:C}", product.Price * (1 - product.DiscountPercentage / 100))
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="price normal-price">
                                                        @string.Format("{0:C}", product.Price)
                                                    </span>
                                                }
                                            </p>

                                            <!-- Hiển thị nhãn Featured -->
                                            <p class="featured-label">
                                                <strong>@GetFeaturedLabel(product.Featured.ToString())</strong>
                                            </p>

                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
                else
                {
                    <p>Không có sản phẩm nào để hiển thị.</p>
                }
            </div>
                <div class="row">
                    @if (products != null && products.Any())
                    {
                        foreach (var product in products)
                        {
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <a href="@Url.Action("DetailProduct", "DetailProduct", new { id = product.Id })">
                                <img src="@product.Image" class="card-img-top" alt="@product.Title" />
                                <div class="card-body">
                                    <h5 class="card-title">@product.Title</h5>
                                    <p class="card-text">
                                        @if (product.DiscountPercentage > 0)
                                        {
                                            <!-- Bọc giảm giá trong một khung hình chữ nhật -->
                                            <span class="badge discount-badge">
                                                Giảm @product.DiscountPercentage%
                                            </span>
                                            <br />
                                            <span class="text-muted old-price">
                                                @string.Format("{0:C}", product.Price)
                                            </span>
                                            <br />
                                            <span class="price new-price">
                                                @string.Format("{0:C}", product.Price * (1 - product.DiscountPercentage / 100))
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="price normal-price">
                                                @string.Format("{0:C}", product.Price)
                                            </span>
                                        }
                                    </p>
                                </div>
                            </a>
                        </div>
                   
                    </div>
                        }
                    }
                    else
                    {
                        <p>Không có sản phẩm nào để hiển thị.</p>
                    }
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    function toggleArrow(item) {
        var subCategoryList = item.querySelector(".subcategories");
        var arrow = item.querySelector(".arrow");

        if (subCategoryList.style.display === "none" || subCategoryList.style.display === "") {
            subCategoryList.style.display = "block";
            arrow.classList.add("open");
        } else {
            subCategoryList.style.display = "none";
            arrow.classList.remove("open");
        }
    }

    function loadProductsByPosition(position) {
        fetch(`/Home/GetProductsByPosition?position=${position}`)
            .then(response => response.text())
            .then(html => {
                document.querySelector('.product-list').innerHTML = html;
            })
            .catch(error => console.error('Error loading products:', error));
    }
</script>
</script>

@functions {
    // Get the correct label based on the FeaturedStatus enum
    public string GetFeaturedLabel(string featured)
    {
        switch (featured)
        {
            case "Nổi bật": return "Nổi bật";
            case "Mới": return "Mới";
            case "Gợi ý": return "Gợi ý";
            default: return ""; // Trả về chuỗi rỗng thay vì "Không nổi bật"
        }
    }
}
